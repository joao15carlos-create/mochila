<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bag of Holding | Tormenta20 System Manager</title>
<style>
/* =========================================
   VARI√ÅVEIS GLOBAIS E TEMA
   ========================================= */
:root {
  --cor-fundo: #eaddca;
  --cor-borda: #5d4037;
  --cor-detalhe: #8d2b2b;
  --cor-texto: #3e2723;
  --cor-pv: #c62828;
  --cor-pm: #1565c0;
  --cor-def: #455a64;
  --cor-tibares: #d4af37;
  --fonte-titulo: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
  --fonte-padrao: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body {
  background-color: #1a1210;
  color: var(--cor-texto);
  font-family: var(--fonte-padrao);
  margin: 0;
  padding-bottom: 120px;
  overflow-x: hidden;
}
h1, h2, h3 {
  font-family: var(--fonte-titulo);
  color: var(--cor-borda);
  text-transform: uppercase;
  text-align: center;
  margin-top: 0;
  letter-spacing: 1px;
}
/* =========================================
   TELAS E CONTAINERS
   ========================================= */
.tela {
  display: none;
  width: 95%;
  max-width: 800px;
  margin: 30px auto;
  background: var(--cor-fundo);
  border: 4px solid var(--cor-borda);
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
  position: relative;
  box-sizing: border-box;
}
.fade-in { animation: fadeIn 0.5s; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
/* =========================================
   BOT√ïES
   ========================================= */
.btn-grande {
  background: var(--cor-borda);
  color: white;
  border: none;
  padding: 16px;
  margin: 10px 0;
  cursor: pointer;
  border-radius: 8px;
  width: 100%;
  font-weight: bold;
  text-transform: uppercase;
  box-shadow: 0 4px 0 #2d1d1a;
  transition: all 0.2s;
  font-size: 1rem;
}
.btn-grande:active {
  transform: translateY(4px);
  box-shadow: none;
}
.btn-sair {
  background: #d32f2f !important;
  color: white !important;
  padding: 8px 18px !important;
  border-radius: 6px !important;
  border: none !important;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.9em;
  text-transform: uppercase;
}
.btn-add {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 75px;
  height: 75px;
  background: var(--cor-detalhe);
  color: white;
  border-radius: 50%;
  border: 4px solid #fff;
  font-size: 45px;
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  padding-bottom: 8px;
}
/* =========================================
   INPUTS
   ========================================= */
input, textarea, select {
  width: 100%;
  padding: 15px;
  margin: 10px 0;
  border-radius: 8px;
  border: 2px solid #bcaaa4;
  background: #fdfaf3;
  box-sizing: border-box;
  font-weight: bold;
  font-size: 1em;
  color: var(--cor-texto);
}
input:focus, textarea:focus {
  outline: none;
  border-color: var(--cor-detalhe);
  background: #fff;
}
/* =========================================
   DASHBOARD JOGADOR
   ========================================= */
.status-container-pro {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin: 25px 0;
}
.status-hero-card {
  display: grid;
  grid-template-columns: 80px 1fr 100px;
  align-items: center;
  background: #fff;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  border-left: 12px solid var(--cor-borda);
  cursor: pointer;
  transition: transform 0.2s;
}
.status-hero-card:active { transform: scale(0.98); }
.card-pv { border-left-color: var(--cor-pv); background: linear-gradient(to right, #fff, #ffebee); }
.card-pm { border-left-color: var(--cor-pm); background: linear-gradient(to right, #fff, #e3f2fd); }
.card-def { border-left-color: var(--cor-def); background: linear-gradient(to right, #fff, #eceff1); }
.estado-morto {
  background: #3e2723 !important;
  border-left-color: #000 !important;
}
.estado-morto .status-main-val { color: #ff0000 !important; text-shadow: 0 0 10px #000; }
.estado-morto .status-label { color: #fff !important; }
.status-label { font-weight: 800; font-size: 0.85em; color: #666; text-transform: uppercase; }
.status-main-val { font-size: 2.8em; font-weight: 900; text-align: center; font-family: var(--fonte-titulo); line-height: 1; }
.status-sub-info { text-align: right; font-weight: bold; font-size: 0.9em; opacity: 0.8; }
.tibares-card {
  background: var(--cor-tibares);
  color: #3e2723;
  margin: 15px 0;
  padding: 18px;
  border-radius: 10px;
  text-align: center;
  font-weight: 900;
  cursor: pointer;
  border: 2px solid #b8860b;
  font-size: 1.3em;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
/* =========================================
   PAINEL DO MESTRE
   ========================================= */
#grid-mestre {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 20px;
}
.monitor-mestre-card {
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  border: 2px solid var(--cor-borda);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  position: relative;
}
.monitor-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 12px; border-bottom: 2px solid #eee; padding-bottom: 8px;
}
.monitor-bar-bg {
  background: #e0e0e0; height: 26px; border-radius: 13px; margin: 12px 0;
  overflow: hidden; position: relative; border: 1px solid #999;
}
.monitor-bar-fill { height: 100%; transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
.bar-label {
  position: absolute; width: 100%; text-align: center; font-size: 0.9em; font-weight: 900;
  color: #000; line-height: 26px; text-shadow: 0 0 5px #fff; left: 0; top: 0; z-index: 2;
}
/* =========================================
   ABAS E LISTAS
   ========================================= */
.abas {
  display: flex; gap: 10px; margin-bottom: 20px;
  border-bottom: 2px solid var(--cor-borda); padding-bottom: 10px;
}
.aba-btn {
  flex: 1; background: #d7ccc8; border: 2px solid var(--cor-borda); padding: 14px;
  cursor: pointer; font-weight: bold; border-radius: 10px 10px 0 0; opacity: 0.7; transition: 0.3s;
}
.aba-btn.ativa {
  background: var(--cor-borda); color: white; opacity: 1; transform: translateY(2px);
}
.magia-container, .item-card {
  margin-bottom: 10px; border: 1px solid #ccc; border-radius: 10px;
  overflow: hidden; background: #fff;
}
.item-card {
  display: flex; justify-content: space-between; align-items: center;
  padding: 15px; cursor: pointer; transition: background 0.2s;
}
.item-card:hover { background-color: #f9f9f9; }
.magia-header-click {
  background: var(--cor-detalhe); color: #f4e4bc; padding: 15px;
  display: flex; justify-content: space-between; align-items: center; cursor: pointer;
}
.magia-conteudo-oculto {
  display: none; padding: 20px; line-height: 1.6; border-top: 1px solid #ccc; background-color: #fffbf0;
}
.categoria-titulo {
  background: #5d4037; color: white; padding: 8px 15px; border-radius: 6px;
  margin-top: 20px; margin-bottom: 10px; font-size: 0.9em; font-weight: bold;
  text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;
}
.badge { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px; }
.badge-vestido { background: #1565c0; color: white; }
.badge-empunhado { background: #c62828; color: white; }
.badge-ajudante { background: #2e7d32; color: white; }
/* =========================================
   MODAIS
   ========================================= */
.modal {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px); z-index: 2000;
  justify-content: center; align-items: center; padding: 15px;
}
.modal-content {
  background: var(--cor-fundo); padding: 30px; border: 5px solid var(--cor-borda);
  width: 100%; max-width: 550px; border-radius: 20px; max-height: 85vh;
  overflow-y: auto; box-sizing: border-box; animation: popIn 0.3s;
}
@keyframes popIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.badge-categoria {
  display: inline-block; padding: 4px 8px; border-radius: 4px;
  background: #eee; font-size: 0.8em; font-weight: bold; color: #555; margin-bottom: 10px;
}
.radio-group { display: flex; gap: 10px; margin: 10px 0; }
.radio-group label {
  flex: 1; background: #fff; padding: 10px; border: 2px solid #ccc; border-radius: 6px;
  text-align: center; cursor: pointer; font-size: 0.9em;
}
.radio-group input[type="radio"] { display: none; }
.radio-group input[type="radio"]:checked + label {
  background: var(--cor-detalhe); color: white; border-color: var(--cor-detalhe);
}
</style>
</head>
<body>

<div id="tela-login" class="tela fade-in" style="display: block;">
  <h1 style="font-size: 2.5em; margin-bottom: 10px;">üéí Bag of Holding</h1>
  <p style="text-align: center; color: var(--cor-detalhe); margin-bottom: 30px; font-weight: bold;">Gerenciador Oficial Tormenta20</p>
  <button class="btn-grande" onclick="abrirModal('modal-login-mestre')">üìú Painel do Mestre</button>
  <button class="btn-grande" style="background:#4a6572" onclick="carregarListaJogadores()">üë§ Entrar como Her√≥i</button>
  <div id="lista-jogadores-login" style="margin-top: 25px; display: grid; gap: 10px;"></div>
  <div style="text-align: center; margin-top: 30px;">
    <button onclick="abrirModal('modal-criar')" style="background:none; border:none; color:var(--cor-detalhe); cursor:pointer; text-decoration:underline; font-weight:bold; font-size: 1.1em;">
      ‚ú® Criar Novo Her√≥i
    </button>
  </div>
</div>

<div id="tela-mestre" class="tela fade-in">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--cor-borda); padding-bottom: 10px;">
    <h2 style="margin:0">üìú Monitor da Mesa</h2>
    <button class="btn-sair" onclick="deslogar()">Sair</button>
  </div>
  <button class="btn-grande" style="background:#8d2b2b" onclick="abrirCompendio()">‚öôÔ∏è Gerenciar Magias Globais</button>
  <button class="btn-grande" style="background:#d4af37; color: #3e2723;" onclick="abrirArsenal()">‚öîÔ∏è Gerenciar Arsenal Global</button>
  <button class="btn-grande" style="background:#2e7d32;" onclick="abrirTesouroGrupo()">üí∞ Ver Tesouro do Grupo</button>
  <div id="grid-mestre"></div>
</div>

<div id="tela-mochila" class="tela fade-in">
  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
    <div>
      <h1 id="nome-exibicao" style="margin:0; text-align: left; font-size: 2em;">Her√≥i</h1>
      <small id="sub-nome" style="color:var(--cor-detalhe); font-weight: bold; font-size: 1.2em;">N√≠vel 1</small>
    </div>
    <div style="display: flex; gap: 10px;">
      <button onclick="abrirModal('modal-editar-perfil')" title="Configura√ß√µes" style="background:none; border:none; font-size:30px; cursor:pointer;">‚öôÔ∏è</button>
      <button class="btn-sair" onclick="deslogar()">Trocar</button>
    </div>
  </div>

  <div class="tibares-card" onclick="abrirCalculadora('tibares', 'üí∞ Alterar Tibares')">
    üí∞ <span id="stat-tib">0</span> T$
  </div>

  <div class="status-container-pro">
    <div class="status-hero-card card-pv" id="card-pv-visual" onclick="abrirCalculadora('pv', '‚ù§Ô∏è Alterar Vida')">
      <span class="status-label" id="lbl-pv" style="color:var(--cor-pv)">VIDA (PV)</span>
      <span class="status-main-val" id="v-pv" style="color:var(--cor-pv)">0</span>
      <span class="status-sub-info">M√ÅX: <span id="v-pv-max">0</span></span>
    </div>
    <div class="status-hero-card card-pm" onclick="abrirCalculadora('pm', 'ü™Ñ Alterar Mana')">
      <span class="status-label" style="color:var(--cor-pm)">MANA (PM)</span>
      <span class="status-main-val" id="v-pm" style="color:var(--cor-pm)">0</span>
      <span class="status-sub-info">M√ÅX: <span id="v-pm-max">0</span></span>
    </div>
    <div class="status-hero-card card-def" onclick="abrirCalculadora('defesaAtual', 'üõ°Ô∏è Alterar Defesa Atual')">
      <span class="status-label" style="color:var(--cor-def)">DEFESA</span>
      <span class="status-main-val" id="v-def" style="color:var(--cor-def)">0</span>
      <span class="status-sub-info">BASE: <span id="v-def-base">0</span></span>
    </div>
  </div>

  <nav class="abas">
    <button class="aba-btn ativa" id="btn-aba-g" onclick="mudarAba('grimorio')">üìñ Grim√≥rio</button>
    <button class="aba-btn" id="btn-aba-p" onclick="mudarAba('preparadas')" style="display:none;">üîÆ Preparadas</button>
    <button class="aba-btn" id="btn-aba-i" onclick="mudarAba('inventario')">üéí Invent√°rio</button>
  </nav>

  <div id="conteudo-grimorio">
    <button class="btn-grande" style="background:#4a6572; font-size:0.9em; padding: 12px;" onclick="abrirCompendio()">üìñ Consultar Magias Globais</button>
    <div id="magias-lista"></div>
  </div>

  <div id="conteudo-preparadas" style="display:none">
    <div style="background:var(--cor-borda); color:white; padding:15px; border-radius:10px; text-align:center; margin-bottom:15px; font-weight:bold;">‚ú® Magias Prontas para Uso</div>
    <p style="font-size:0.85em; color:#666; text-align:center; margin-top:0;">Selecione as magias no seu Grim√≥rio para prepar√°-las.</p>
    <div id="magias-preparadas-lista"></div>
  </div>

  <div id="conteudo-inventario" style="display:none">
    <div id="barra-carga" style="background:var(--cor-borda); color:white; padding:15px; border-radius:10px; text-align:center; margin-bottom:15px; font-weight:bold; box-shadow: inset 0 0 10px rgba(0,0,0,0.3);"></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <button class="btn-grande" style="background:#d4af37; color:#3e2723; font-size:0.8em; padding: 10px;" onclick="abrirArsenal()">‚öîÔ∏è Arsenal Global</button>
      <button class="btn-grande" style="background:#2e7d32; font-size:0.8em; padding: 10px;" onclick="abrirTesouroGrupo()">üí∞ Tesouro do Grupo</button>
    </div>
    <div id="itens-lista"></div>
  </div>

  <button id="btn-mestre-voltar" style="display:none; background:#d32f2f; margin-top: 30px;" class="btn-grande" onclick="mostrarPainelMestre()">‚¨Ö VOLTAR AO MONITOR</button>
</div>

<div id="modal-calculadora" class="modal">
  <div class="modal-content">
    <h3 id="calc-titulo">Modificar Valor</h3>
    <p style="text-align:center; color:#666">Valores negativos reduzem (ex: -5).</p>
    <input type="number" id="calc-input" placeholder="Digite o valor" autofocus>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <button class="btn-grande" style="background:#2e7d32" onclick="aplicarCalculo()">Confirmar</button>
      <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-calculadora')">Cancelar</button>
    </div>
  </div>
</div>

<div id="modal-detalhe-item" class="modal">
  <div class="modal-content">
    <input type="hidden" id="detalhe-item-index">
    <h3 id="detalhe-titulo-item">Nome do Item</h3>
    <span id="detalhe-badge-cat" class="badge-categoria">Categoria</span>
    <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px;">
      <p id="detalhe-desc-item" style="margin-top:0; white-space: pre-wrap;"></p>
      <div style="margin-top:10px; font-weight:bold; color:#666;">
        Qtd: <span id="detalhe-qtd"></span> | Espa√ßos: <span id="detalhe-espacos"></span><br>
        <span id="detalhe-estado-txt" style="color:var(--cor-detalhe)"></span><br>
        <span id="detalhe-local-txt" style="color:#2e7d32"></span>
      </div>
    </div>
    <div style="display: grid; gap: 10px;">
      <button id="btn-usar-item" class="btn-grande" style="background:#e65100; display:none;" onclick="usarItemAtual()">üß™ USAR ITEM (Consumir)</button>
      <button class="btn-grande" style="background:#4a6572" onclick="abrirTransferencia()">üéÅ Transferir p/ Jogador</button>
      <button class="btn-grande" style="background:#2e7d32" onclick="enviarParaTesouro()">üí∞ Enviar p/ Tesouro Grupo</button>
      <button class="btn-grande" onclick="editarItemAtual()">‚úèÔ∏è Editar Item</button>
      <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-detalhe-item')">Fechar</button>
    </div>
  </div>
</div>

<div id="modal-transferir" class="modal">
  <div class="modal-content">
    <h3>üéÅ Transferir Item</h3>
    <p style="text-align:center; color:#555">Selecione o destinat√°rio.</p>
    <select id="select-destinatario"></select>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <button class="btn-grande" onclick="confirmarTransferencia()">Enviar</button>
      <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-transferir')">Cancelar</button>
    </div>
  </div>
</div>

<div id="modal-editar-perfil" class="modal">
  <div class="modal-content">
    <h3>‚öôÔ∏è Editar Ficha</h3>
    <label>Nome do Personagem</label>
    <input type="text" id="e-nome">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <div><label>N√≠vel</label><input type="number" id="e-nv"></div>
      <div><label>For√ßa</label><input type="number" id="e-for"></div>
      <div><label>PV M√°ximo</label><input type="number" id="e-pv-max"></div>
      <div><label>PM M√°ximo</label><input type="number" id="e-pm-max"></div>
      <div><label>Defesa Base</label><input type="number" id="e-def-base"></div>
      <div><label>Tibares (Ouro)</label><input type="number" id="e-tib"></div>
    </div>
    <label style="margin-top:10px; display:block;">Prepara Magias?</label>
    <select id="e-prepara">
      <option value="nao">N√£o</option>
      <option value="sim">Sim</option>
    </select>
    <button class="btn-grande" onclick="salvarEdicaoPerfil()">Salvar Altera√ß√µes</button>
    <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-editar-perfil')">Fechar</button>
  </div>
</div>

<div id="modal-item" class="modal">
  <div class="modal-content">
    <h3 id="modal-titulo">Novo Registro</h3>
    <input type="hidden" id="edit-id-global">
    <input type="hidden" id="edit-index-local">

    <select id="tipo-registro" onchange="ajustarCampos()">
      <option value="magia">‚ú® Magia / Habilidade</option>
      <option value="item">‚öîÔ∏è Item / Equipamento</option>
    </select>

    <input type="text" id="nome-reg" placeholder="Nome do Registro">
    
    <div id="campos-magia">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="text" id="m-escola" placeholder="Escola">
        <input type="text" id="m-circulo" placeholder="C√≠rculo/Custo">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="text" id="m-execucao" placeholder="Execu√ß√£o">
        <input type="text" id="m-alcance" placeholder="Alcance">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
        <input type="text" id="m-duracao" placeholder="Dura√ß√£o">
        <input type="text" id="m-tipo" placeholder="Alvo">
        <input type="text" id="m-resistencia" placeholder="Resist√™ncia">
      </div>
      <label style="display:block; margin-top:10px; color:#666; font-weight:bold;">Aprimoramentos (+):</label>
      <textarea id="m-aprimora" rows="3" style="margin-top:5px;" placeholder="+ Aumenta o dano em 1d6..."></textarea>
    </div>
    
    <label style="display:block; margin-top:10px; color:#666; font-weight:bold;">Descri√ß√£o:</label>
    <textarea id="desc-reg" rows="5" style="margin-top:5px;"></textarea>
    
    <div id="campos-item" style="display:none">
      <label style="color:#666; font-weight:bold;">Categoria:</label>
      <select id="i-categoria">
        <option value="mundanos">üéí Itens Mundanos</option>
        <option value="armaduras">üõ°Ô∏è Armaduras e Escudos</option>
        <option value="armas">‚öîÔ∏è Armas</option>
        <option value="pocoes">üß™ Po√ß√µes</option>
        <option value="pergaminhos">üìú Pergaminhos</option>
        <option value="magicos">‚ú® Itens M√°gicos</option>
      </select>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="number" id="i-espacos" placeholder="Slots" value="1">
        <input type="number" id="i-qtd" placeholder="Qtd" value="1">
      </div>
      
      <label style="color:#666; font-weight:bold; margin-top:10px; display:block;">Estado:</label>
      <div class="radio-group">
        <input type="radio" id="st-nenhum" name="estado-item" value="nenhum" checked>
        <label for="st-nenhum">Guardado</label>
        <input type="radio" id="st-empunhado" name="estado-item" value="empunhado">
        <label for="st-empunhado">‚öîÔ∏è Empunhado</label>
        <input type="radio" id="st-vestido" name="estado-item" value="vestido">
        <label for="st-vestido">üëï Vestido (Max 4)</label>
      </div>

      <label style="color:#666; font-weight:bold; margin-top:10px; display:block;">Onde est√°?</label>
      <select id="i-localizacao" onchange="toggleNomeAjudante()">
        <option value="personagem">üë§ Com o Personagem</option>
        <option value="ajudante">üê¥ Com Ajudante</option>
        <option value="tesouro">üí∞ No Tesouro (Se criar direto)</option>
      </select>
      <input type="text" id="i-nome-ajudante" placeholder="Nome do Ajudante" style="display:none; border-color:#2e7d32;">
    </div>
    
    <div id="div-enviar-arsenal" style="margin-top:10px; display:flex; align-items:center; gap:10px;">
      <input type="checkbox" id="i-publico" style="width:auto; margin:0;">
      <label for="i-publico" style="font-weight:bold; color:var(--cor-detalhe);">Salvar no Arsenal/Biblioteca Global</label>
    </div>

    <button class="btn-grande" onclick="salvarNovo()">Salvar</button>
    <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-item')">Voltar</button>
  </div>
</div>

<div id="modal-login-jogador" class="modal">
  <div class="modal-content">
    <h3 id="txt-login-nome">Login</h3>
    <input type="password" id="pass-jogador" placeholder="Senha da Ficha">
    <button class="btn-grande" onclick="validarJogador(false)">Acessar Ficha</button>
    <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-login-jogador')">Voltar</button>
  </div>
</div>

<div id="modal-login-mestre" class="modal">
  <div class="modal-content">
    <h3>Acesso do Mestre</h3>
    <input type="password" id="pass-mestre" placeholder="Senha do Mestre">
    <button class="btn-grande" onclick="validarMestre()">Entrar no Monitor</button>
    <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-login-mestre')">Voltar</button>
  </div>
</div>

<div id="modal-criar" class="modal">
  <div class="modal-content">
    <h3>Forjar Novo Her√≥i</h3>
    <p style="color:#666; text-align:center">Preencha os dados iniciais obrigat√≥rios.</p>
    <input type="text" id="n-nome" placeholder="Nome do Personagem">
    <input type="password" id="n-senha" placeholder="Crie uma Senha">
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <input type="number" id="n-for" placeholder="For√ßa (Ex: 2)">
      <input type="number" id="n-def" placeholder="Defesa Base (Ex: 10)">
      <input type="number" id="n-pv" placeholder="PV M√°ximo (Ex: 20)">
      <input type="number" id="n-pm" placeholder="PM M√°ximo (Ex: 10)">
      <input type="number" id="n-tib" placeholder="Tibares (Ex: 100)">
    </div>

    <label style="margin-top:10px; display:block; color:#666; font-weight:bold;">O personagem prepara magias?</label>
    <select id="n-prepara">
      <option value="nao">N√£o</option>
      <option value="sim">Sim</option>
    </select>

    <button class="btn-grande" onclick="criarHeroi()">Criar Ficha</button>
    <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-criar')">Cancelar</button>
  </div>
</div>

<div id="modal-compendio" class="modal">
  <div class="modal-content">
    <h3 id="titulo-compendio">üìñ Biblioteca Global</h3>
    <p id="subtitulo-compendio" style="text-align:center; font-size:0.9em; color:#555">Base de dados compartilhada.</p>
    <div id="lista-compendio" style="max-height: 400px; overflow-y: auto;"></div>
    <button class="btn-grande" onclick="fecharModal('modal-compendio')">Fechar</button>
  </div>
</div>

<button class="btn-add" id="btn-flutuante" style="display:none" onclick="abrirModal('modal-item')">+</button>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
// CONFIGURA√á√ÉO FIREBASE (MANTIDA IGUAL)
const firebaseConfig = {
  apiKey: "AIzaSyCwv-I1QdEZJlAJAMX4aOvGxaCRRQiHGM8",
  authDomain: "mochila-548a0.firebaseapp.com",
  projectId: "mochila-548a0",
  storageBucket: "mochila-548a0.firebasestorage.app",
  messagingSenderId: "823862724587",
  appId: "1:823862724587:web:d452ced78e9848e4f8fbae"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let heroiAtivo = null;
let idTemp = null;
let campoAtual = '';
let modoMestreAtivo = false;
let listenerHeroi = null;

const categoriasNomes = {
  'mundanos': 'üéí Itens Mundanos',
  'armaduras': 'üõ°Ô∏è Armaduras e Escudos',
  'armas': '‚öîÔ∏è Armas',
  'pocoes': 'üß™ Po√ß√µes',
  'pergaminhos': 'üìú Pergaminhos',
  'magicos': '‚ú® Itens M√°gicos'
};

// Formata√ß√£o inteligente da Magia (Regex para Quebra Autom√°tica)
function formatarAprimoramento(texto) {
    if (!texto) return '';
    // A Regex captura \b([1-9]|[1-2][0-9]|30)\b garantindo n√∫meros apenas entre 1 e 30
    let formatado = texto.replace(/(\+\s*\b(?:[1-9]|[1-2][0-9]|30)\b\s*PM)/gi, '<br><br><b>$1</b>');
    // Removemos os primeiros <br> caso a string j√° comece com um b√¥nus para n√£o dar espa√ßo extra
    formatado = formatado.replace(/^(?:<br\s*\/?>\s*)+/, '');
    return `<div style="background:#fdfaf3;padding:10px;border-left:4px solid var(--cor-detalhe);margin-top:10px; color:#5d4037;"><b>‚ú® Aprimoramentos:</b><br>${formatado}</div>`;
}

// ============================================
// RENDERIZA√á√ÉO E NAVEGA√á√ÉO
// ============================================
function renderTudo() {
  if(!heroiAtivo) return;
  document.getElementById('nome-exibicao').innerText = heroiAtivo.nome;
  document.getElementById('sub-nome').innerText = `N√≠vel ${heroiAtivo.nivel}`;
  document.getElementById('stat-tib').innerText = (heroiAtivo.tibares || 0).toLocaleString();

  // Visibilidade de aba "Preparadas"
  document.getElementById('btn-aba-p').style.display = heroiAtivo.preparaMagias ? 'block' : 'none';

  // Status & Morte
  let pv = heroiAtivo.pv;
  let pvMax = heroiAtivo.pvMax;
  const limiteMorte = -Math.floor(pvMax / 2);

  const cardPv = document.getElementById('card-pv-visual');
  const lblPv = document.getElementById('lbl-pv');
  document.getElementById('v-pv').innerText = pv;
  document.getElementById('v-pv-max').innerText = pvMax;
  document.getElementById('v-pm').innerText = heroiAtivo.pm;
  document.getElementById('v-pm-max').innerText = heroiAtivo.pmMax;
  
  if (pv <= limiteMorte) {
    cardPv.classList.add('estado-morto');
    lblPv.innerText = "üíÄ MORTO";
  } else {
    cardPv.classList.remove('estado-morto');
    lblPv.innerText = "VIDA (PV)";
  }

  const defBase = heroiAtivo.defesaBase !== undefined ? heroiAtivo.defesaBase : (heroiAtivo.defesa || 10);
  const defAtual = heroiAtivo.defesaAtual !== undefined ? heroiAtivo.defesaAtual : defBase;
  document.getElementById('v-def').innerText = defAtual;
  document.getElementById('v-def-base').innerText = defBase;

  // Render Magias
  const g = document.getElementById('magias-lista');
  g.innerHTML = "";
  (heroiAtivo.magias || []).forEach((m, idx) => {
    let detalhes = [];
    if(m.execucao) detalhes.push(`<b>Exec:</b> ${m.execucao}`);
    if(m.alcance) detalhes.push(`<b>Alc:</b> ${m.alcance}`);
    if(m.duracao) detalhes.push(`<b>Dur:</b> ${m.duracao}`);
    const linhaDetalhes = detalhes.length > 0 ? `<div style="font-size:0.85em; background:#eee; padding:5px; border-radius:4px; margin-bottom:8px;">${detalhes.join(' ‚Ä¢ ')}</div>` : '';

    const isPrep = (heroiAtivo.magiasPreparadas || []).includes(m.nome);
    let btnPrep = '';
    if(heroiAtivo.preparaMagias) {
        if(isPrep) {
            btnPrep = `<button onclick="togglePrepararMagia('${m.nome}'); event.stopPropagation();" style="background:#4a6572;color:white;border:none;padding:6px 10px;border-radius:5px;cursor:pointer;margin-right:10px;font-size:0.8em">Despreparar</button>`;
        } else {
            btnPrep = `<button onclick="togglePrepararMagia('${m.nome}'); event.stopPropagation();" style="background:var(--cor-detalhe);color:white;border:none;padding:6px 10px;border-radius:5px;cursor:pointer;margin-right:10px;font-size:0.8em">Preparar</button>`;
        }
    }

    let aprimoraHtml = formatarAprimoramento(m.aprimora);

    g.innerHTML += `
    <div class="magia-container">
      <div class="magia-header-click" onclick="toggleMagia(${idx})">
        <div>
          <b style="font-size:1.1em">${m.nome}</b><br>
          <small style="opacity:0.9">${m.escola || ''} ${m.circulo ? ' - ' + m.circulo : ''}</small>
        </div>
        <div>
          ${btnPrep}
          <button onclick="removerAlgo('magias', ${idx}); event.stopPropagation();" style="background:none;border:none;color:white;font-size:20px;cursor:pointer">üóëÔ∏è</button>
        </div>
      </div>
      <div id="magia-info-${idx}" class="magia-conteudo-oculto">
        ${linhaDetalhes}
        <p style="margin-top:0">${m.desc}</p>
        ${aprimoraHtml}
      </div>
    </div>`;
  });

  // Render Magias Preparadas
  const pList = document.getElementById('magias-preparadas-lista');
  if(heroiAtivo.preparaMagias && pList) {
    pList.innerHTML = "";
    const preparadas = (heroiAtivo.magias || []).filter(mag => (heroiAtivo.magiasPreparadas || []).includes(mag.nome));
    if (preparadas.length === 0) {
        pList.innerHTML = "<p style='text-align:center; color:#777;'>Nenhuma magia preparada no momento.</p>";
    } else {
        preparadas.forEach(m => {
            pList.innerHTML += `
            <div class="magia-container" style="border-left: 4px solid var(--cor-pm);">
                <div style="padding:15px; display:flex; justify-content:space-between; align-items:center; background:#fff;">
                    <div><b style="font-size:1.1em">${m.nome}</b><br><small>${m.escola || ''} ${m.circulo ? ' - ' + m.circulo : ''}</small></div>
                    <button onclick="togglePrepararMagia('${m.nome}')" style="background:#d32f2f;color:white;border:none;padding:6px 10px;border-radius:5px;cursor:pointer;font-weight:bold;font-size:0.8em;">Remover</button>
                </div>
            </div>`;
        });
    }
  }

  // Render Invent√°rio
  const iL = document.getElementById('itens-lista');
  iL.innerHTML = "";
  let slotsUsados = 0;
  const itensPorCat = { 'mundanos':[], 'armaduras':[], 'armas':[], 'pocoes':[], 'pergaminhos':[], 'magicos':[] };
  
  (heroiAtivo.itens || []).forEach((it, idx) => {
    if(!it.localizacao || it.localizacao === 'personagem') {
      const slotsItem = it.espacos !== undefined ? Number(it.espacos) : (it.peso || 1);
      slotsUsados += (slotsItem * Number(it.qtd));
    }
    const cat = it.categoria && itensPorCat[it.categoria] ? it.categoria : 'mundanos';
    itensPorCat[cat].push({ ...it, originalIndex: idx });
  });

  const ordem = ['armas', 'armaduras', 'pocoes', 'pergaminhos', 'magicos', 'mundanos'];
  ordem.forEach(catKey => {
    const lista = itensPorCat[catKey];
    if(lista.length > 0) {
      iL.innerHTML += `<div class="categoria-titulo">${categoriasNomes[catKey]}</div>`;
      lista.forEach(it => {
        let iconState = "";
        if(it.estado === 'vestido') iconState = `<span class="badge badge-vestido">üëï VESTIDO</span>`;
        if(it.estado === 'empunhado') iconState = `<span class="badge badge-empunhado">‚öîÔ∏è EMPUNHADO</span>`;

        let iconLocal = "";
        if(it.localizacao === 'ajudante') iconLocal = `<span class="badge badge-ajudante">üê¥ ${it.nomeAjudante || 'Ajudante'}</span>`;
        if(it.localizacao === 'tesouro') iconLocal = `<span class="badge badge-ajudante">üí∞ No Tesouro</span>`;

        iL.innerHTML += `
        <div class="item-card" onclick="verItemDetalhe(${it.originalIndex})">
          <div>
            <b style="font-size:1.1em">${it.nome}</b> ${iconState} ${iconLocal}<br>
            <span style="color:#666">${it.qtd}x ‚Ä¢ ${it.espacos || 1} slots</span>
          </div>
          <button onclick="removerAlgo('itens', ${it.originalIndex}); event.stopPropagation();" style="color:#d32f2f;border:none;background:none;font-size:22px;cursor:pointer">üóëÔ∏è</button>
        </div>`;
      });
    }
  });

  if(heroiAtivo.itens.length === 0) iL.innerHTML = "<p style='text-align:center; color:#777; margin-top:20px'>Mochila vazia.</p>";
  const slotsMax = 10 + (2 * heroiAtivo.forca);
  document.getElementById('barra-carga').innerText = `Espa√ßos: ${slotsUsados} / ${slotsMax}`;
  document.getElementById('barra-carga').style.background = slotsUsados > slotsMax ? '#d32f2f' : 'var(--cor-borda)';
}

async function togglePrepararMagia(nomeMagia) {
    if(!heroiAtivo.magiasPreparadas) heroiAtivo.magiasPreparadas = [];
    const pos = heroiAtivo.magiasPreparadas.indexOf(nomeMagia);
    if(pos > -1) heroiAtivo.magiasPreparadas.splice(pos, 1);
    else heroiAtivo.magiasPreparadas.push(nomeMagia);
    await db.collection("personagens").doc(heroiAtivo.id).update({magiasPreparadas: heroiAtivo.magiasPreparadas});
    renderTudo();
}

// ============================================
// LIMPEZA E FORMUL√ÅRIOS
// ============================================
function limparFormularioItem() {
    document.getElementById('edit-id-global').value = "";
    document.getElementById('edit-index-local').value = "";
    document.getElementById('nome-reg').value = "";
    document.getElementById('desc-reg').value = "";
    document.getElementById('m-escola').value = "";
    document.getElementById('m-circulo').value = "";
    document.getElementById('m-aprimora').value = "";
    document.getElementById('m-execucao').value = "";
    document.getElementById('m-alcance').value = "";
    document.getElementById('m-duracao').value = "";
    document.getElementById('m-tipo').value = "";
    document.getElementById('m-resistencia').value = "";
    document.getElementById('i-espacos').value = "1";
    document.getElementById('i-qtd').value = "1";
    document.getElementById('st-nenhum').checked = true;
    document.getElementById('i-localizacao').value = 'personagem';
    document.getElementById('i-nome-ajudante').value = '';
    document.getElementById('i-publico').checked = false;
    toggleNomeAjudante();
}

function verItemDetalhe(idx) {
  const item = heroiAtivo.itens[idx];
  document.getElementById('detalhe-item-index').value = idx;
  document.getElementById('detalhe-titulo-item').innerText = item.nome;
  document.getElementById('detalhe-badge-cat').innerText = categoriasNomes[item.categoria] || 'Item';
  document.getElementById('detalhe-desc-item').innerText = item.desc || "Sem descri√ß√£o.";
  document.getElementById('detalhe-qtd').innerText = item.qtd;
  document.getElementById('detalhe-espacos').innerText = item.espacos || 1;

  let txtEstado = "Estado: Guardado";
  if(item.estado === 'vestido') txtEstado = "Estado: üëï Vestido (+ B√¥nus Ativo)";
  if(item.estado === 'empunhado') txtEstado = "Estado: ‚öîÔ∏è Empunhado";
  document.getElementById('detalhe-estado-txt').innerText = txtEstado;

  let txtLocal = "Local: Com Personagem";
  if(item.localizacao === 'ajudante') txtLocal = `Local: üê¥ Com ${item.nomeAjudante || 'Ajudante'}`;
  if(item.localizacao === 'tesouro') txtLocal = "Local: üí∞ No Tesouro";
  document.getElementById('detalhe-local-txt').innerText = txtLocal;

  const btnUsar = document.getElementById('btn-usar-item');
  if (item.categoria === 'pocoes' || item.categoria === 'pergaminhos') btnUsar.style.display = 'block';
  else btnUsar.style.display = 'none';
  
  abrirModal('modal-detalhe-item');
}

async function usarItemAtual() {
  const idx = document.getElementById('detalhe-item-index').value;
  const item = heroiAtivo.itens[idx];
  if(confirm(`Deseja usar 1x ${item.nome}?`)) {
    item.qtd--;
    if(item.qtd <= 0) {
      heroiAtivo.itens.splice(idx, 1);
      fecharModal('modal-detalhe-item');
    }
    await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo);
    renderTudo();
  }
}

async function enviarParaTesouro() {
  const idx = document.getElementById('detalhe-item-index').value;
  const item = heroiAtivo.itens[idx];
  if(confirm(`Enviar ${item.nome} para o Tesouro do Grupo?`)) {
    const itemTesouro = {...item};
    itemTesouro.localizacao = 'tesouro';
    delete itemTesouro.estado; delete itemTesouro.nomeAjudante;
    await db.collection("tesouro_grupo").add(itemTesouro);

    heroiAtivo.itens.splice(idx, 1);
    await db.collection("personagens").doc(heroiAtivo.id).update({itens: heroiAtivo.itens});

    alert("Item enviado para o Ba√∫!");
    fecharModal('modal-detalhe-item');
    renderTudo();
  }
}

function editarItemAtual() {
  const idx = document.getElementById('detalhe-item-index').value;
  const item = heroiAtivo.itens[idx];
  fecharModal('modal-detalhe-item');
  abrirModal('modal-item');

  document.getElementById('modal-titulo').innerText = "Editar Item";
  document.getElementById('edit-index-local').value = idx;
  document.getElementById('tipo-registro').value = 'item';
  document.getElementById('nome-reg').value = item.nome;
  document.getElementById('desc-reg').value = item.desc;
  document.getElementById('i-categoria').value = item.categoria || 'mundanos';
  document.getElementById('i-espacos').value = item.espacos || 1;
  document.getElementById('i-qtd').value = item.qtd;

  if(item.estado === 'vestido') document.getElementById('st-vestido').checked = true;
  else if(item.estado === 'empunhado') document.getElementById('st-empunhado').checked = true;
  else document.getElementById('st-nenhum').checked = true;

  document.getElementById('i-localizacao').value = item.localizacao || 'personagem';
  document.getElementById('i-nome-ajudante').value = item.nomeAjudante || '';
  toggleNomeAjudante();
  
  // Op√ß√£o de enviar pro arsenal fica ativada na edi√ß√£o do item 
  document.getElementById('div-enviar-arsenal').style.display = 'flex';
  ajustarCampos();
}

async function abrirTesouroGrupo() {
  abrirModal('modal-compendio');
  document.getElementById('titulo-compendio').innerText = "üí∞ Tesouro do Grupo";
  document.getElementById('subtitulo-compendio').innerText = "Itens compartilhados. N√£o ocupam espa√ßo.";

  const snap = await db.collection("tesouro_grupo").orderBy('nome').get();
  const lista = document.getElementById('lista-compendio');
  lista.innerHTML = "";

  if(snap.empty) { lista.innerHTML = "<p style='text-align:center'>O ba√∫ est√° vazio.</p>"; return; }
  snap.forEach(doc => {
    const m = doc.data(); const id = doc.id;
    let btns = heroiAtivo ? `<button class="aba-btn ativa" style="padding:5px 10px; font-size:0.8em" onclick='pegarDoTesouro("${id}", ${JSON.stringify(m)})'>üì• Pegar</button>` : `<small>Apenas Jogadores</small>`;
    lista.innerHTML += `
    <div style="background:white;padding:12px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><b>${m.nome}</b> <span class="badge-categoria">${categoriasNomes[m.categoria] || 'Item'}</span></div>
        <div>${btns}</div>
      </div>
      <p style="font-size:0.9em; margin:5px 0">${m.desc}</p>
      <small>Qtd: ${m.qtd}</small>
    </div>`;
  });
}

async function pegarDoTesouro(idDoc, itemData) {
  if(!heroiAtivo) return;
  if(confirm(`Pegar ${itemData.nome} do ba√∫?`)) {
    const novoItem = {...itemData};
    novoItem.localizacao = 'personagem'; 
    heroiAtivo.itens.push(novoItem);
    await db.collection("tesouro_grupo").doc(idDoc).delete();
    await db.collection("personagens").doc(heroiAtivo.id).update({ itens: heroiAtivo.itens });
    alert("Item retirado do ba√∫!");
    abrirTesouroGrupo(); 
    renderTudo(); 
  }
}

async function salvarNovo() {
  const tipo = document.getElementById('tipo-registro').value;
  const globalId = document.getElementById('edit-id-global').value;
  const localIndex = document.getElementById('edit-index-local').value;

  const d = { nome: document.getElementById('nome-reg').value, desc: document.getElementById('desc-reg').value };
  if(!d.nome) return alert("O nome √© obrigat√≥rio!");

  if (tipo === 'magia') {
    d.escola = document.getElementById('m-escola').value;
    d.circulo = document.getElementById('m-circulo').value;
    d.aprimora = document.getElementById('m-aprimora').value;
    d.execucao = document.getElementById('m-execucao').value;
    d.alcance = document.getElementById('m-alcance').value;
    d.duracao = document.getElementById('m-duracao').value;
    d.tipo = document.getElementById('m-tipo').value;
    d.resistencia = document.getElementById('m-resistencia').value;

    if (globalId) await db.collection("magias_globais").doc(globalId).update(d);
    else {
      if(document.getElementById('modal-titulo').innerText.includes("Biblioteca")) await db.collection("magias_globais").add(d);
      else if(heroiAtivo) {
          heroiAtivo.magias.push(d);
          const enviarArsenal = document.getElementById('i-publico').checked;
          if (enviarArsenal) await db.collection("magias_globais").add(d);
      }
    }
  } else {
    // ITEM
    d.categoria = document.getElementById('i-categoria').value;
    d.espacos = Number(document.getElementById('i-espacos').value);
    d.qtd = Number(document.getElementById('i-qtd').value);

    const radios = document.getElementsByName('estado-item');
    for(let r of radios) if(r.checked) d.estado = r.value;

    if(d.estado === 'vestido' && heroiAtivo) {
      let countVestidos = 0;
      heroiAtivo.itens.forEach((it, idx) => {
        if (localIndex === "" || idx != localIndex) {
          if (it.estado === 'vestido') countVestidos++;
        }
      });
      if(countVestidos >= 4) return alert("Voc√™ j√° tem 4 itens vestidos! Remova um antes.");
    }

    d.localizacao = document.getElementById('i-localizacao').value;
    if(d.localizacao === 'ajudante') {
      d.nomeAjudante = document.getElementById('i-nome-ajudante').value;
      if(!d.nomeAjudante) return alert("Informe o nome do Ajudante!");
    }

    if (globalId) {
      await db.collection("itens_globais").doc(globalId).update(d);
    } else if (localIndex !== "") {
      heroiAtivo.itens[localIndex] = d;
      // Trata o envio de item existente (Editado) para o arsenal
      if(document.getElementById('i-publico').checked) {
          const copy = {...d}; delete copy.estado; delete copy.localizacao;
          await db.collection("itens_globais").add(copy);
          alert("Uma c√≥pia do item editado foi enviada ao Arsenal Global!");
      }
    } else {
      const enviarArsenal = document.getElementById('i-publico').checked;
      if(document.getElementById('modal-titulo').innerText.includes("Arsenal Global")) {
        await db.collection("itens_globais").add(d);
      } else if(heroiAtivo) {
        heroiAtivo.itens.push(d);
        if(enviarArsenal) {
          const copy = {...d}; delete copy.estado; delete copy.localizacao;
          await db.collection("itens_globais").add(copy);
          alert("Item salvo na ficha e enviado ao Arsenal Global!");
        }
      }
    }
  }

  if(heroiAtivo && !globalId) await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo);

  // Regra: Limpeza Autom√°tica do Formul√°rio mantendo-o pronto para novo registro
  if(localIndex === "" && !globalId && !document.getElementById('modal-titulo').innerText.includes("Global")) {
     alert("Cadastrado com sucesso!");
     limparFormularioItem(); 
  } else {
     fecharModal('modal-item');
  }
  
  if(globalId || document.getElementById('modal-titulo').innerText.includes("Global")) {
    if(tipo === 'magia') abrirCompendio();
    if(tipo === 'item') abrirArsenal();
  }
}

function deslogar() {
  if(listenerHeroi) { listenerHeroi(); listenerHeroi = null; }
  heroiAtivo = null; modoMestreAtivo = false;
  document.querySelectorAll('.tela').forEach(t => t.style.display = 'none');
  document.getElementById('tela-login').style.display = 'block';
  document.getElementById('btn-flutuante').style.display = 'none';
}

async function validarJogador(viaMestre) {
  const docRef = db.collection("personagens").doc(idTemp);
  const doc = await docRef.get();
  if (!doc.exists) return alert("Erro no personagem.");
  if(viaMestre || doc.data().senha === document.getElementById('pass-jogador').value) {
    listenerHeroi = docRef.onSnapshot((snapshot) => {
      if (snapshot.exists) { heroiAtivo = { id: snapshot.id, ...snapshot.data() }; renderTudo(); }
      else deslogar();
    });
    fecharModal('modal-login-jogador');
    document.querySelectorAll('.tela').forEach(t => t.style.display = 'none');
    document.getElementById('tela-mochila').style.display = 'block';
    document.getElementById('btn-flutuante').style.display = 'block';
    document.getElementById('btn-mestre-voltar').style.display = modoMestreAtivo ? 'block' : 'none';
  } else alert("Senha incorreta!");
}

async function validarMestre() {
  if(document.getElementById('pass-mestre').value === "mestre123") {
    modoMestreAtivo = true; fecharModal('modal-login-mestre'); mostrarPainelMestre();
  } else alert("Senha inv√°lida!");
}

function mostrarPainelMestre() {
  if(listenerHeroi) { listenerHeroi(); listenerHeroi = null; }
  document.querySelectorAll('.tela').forEach(t => t.style.display = 'none');
  document.getElementById('tela-mestre').style.display = 'block';
  
  db.collection("personagens").onSnapshot(snap => {
    const grid = document.getElementById('grid-mestre'); grid.innerHTML = "";
    snap.forEach(doc => {
      const h = doc.data();
      let pvCalc = h.pv;
      if(pvCalc < 0) pvCalc = 0;
      const perPV = Math.min((pvCalc / h.pvMax) * 100, 100);
      const perPM = Math.min((h.pm / h.pmMax) * 100, 100);
      const mortoLbl = h.pv <= -Math.floor(h.pvMax/2) ? '<span style="color:red; font-weight:bold"> (MORTO)</span>' : '';
      
      grid.innerHTML += `
      <div class="monitor-mestre-card">
        <div class="monitor-header">
          <div>
            <b>${h.nome} ${mortoLbl}</b><br>
            <small style="color:#666; font-weight:normal">Senha: ${h.senha}</small>
          </div>
          <div style="display:flex; gap:5px;">
            <button onclick="idTemp='${doc.id}'; validarJogador(true)" style="background:var(--cor-borda);color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">ABRIR</button>
            <button onclick="deletarPersonagem('${doc.id}', '${h.nome}')" style="background:#d32f2f;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">X</button>
          </div>
        </div>
        <div class="monitor-bar-bg"><div class="monitor-bar-fill" style="width:${perPV}%; background:var(--cor-pv)"></div><div class="bar-label">${h.pv} / ${h.pvMax} PV</div></div>
        <div class="monitor-bar-bg"><div class="monitor-bar-fill" style="width:${perPM}%; background:var(--cor-pm)"></div><div class="bar-label">${h.pm} / ${h.pmMax} PM</div></div>
      </div>`;
    });
  });
}

async function aplicarCalculo() {
  const val = Number(document.getElementById('calc-input').value);
  if(isNaN(val)) return;

  if (campoAtual === 'defesaAtual') {
    if(heroiAtivo.defesaAtual === undefined) heroiAtivo.defesaAtual = heroiAtivo.defesa || 10;
    heroiAtivo.defesaAtual += val;
  } else {
    heroiAtivo[campoAtual] += val;
    if(campoAtual === 'pv') if (heroiAtivo.pv > heroiAtivo.pvMax) heroiAtivo.pv = heroiAtivo.pvMax;
    if(campoAtual === 'pm') {
      if (heroiAtivo.pm > heroiAtivo.pmMax) heroiAtivo.pm = heroiAtivo.pmMax;
      if (heroiAtivo.pm < 0) heroiAtivo.pm = 0;
    }
  }
  await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo);
  fecharModal('modal-calculadora');
}

function toggleNomeAjudante() {
  const val = document.getElementById('i-localizacao').value;
  document.getElementById('i-nome-ajudante').style.display = val === 'ajudante' ? 'block' : 'none';
}

async function abrirTransferencia() {
  fecharModal('modal-detalhe-item');
  const select = document.getElementById('select-destinatario');
  select.innerHTML = "<option>Carregando...</option>";
  abrirModal('modal-transferir');
  const snap = await db.collection("personagens").get();
  select.innerHTML = "";
  snap.forEach(doc => {
    if(doc.id !== heroiAtivo.id) select.innerHTML += `<option value="${doc.id}">${doc.data().nome}</option>`;
  });
}

async function confirmarTransferencia() {
  const idx = document.getElementById('detalhe-item-index').value;
  const targetId = document.getElementById('select-destinatario').value;
  if(!targetId) return;

  const item = heroiAtivo.itens[idx];
  const targetRef = db.collection("personagens").doc(targetId);
  const tSnap = await targetRef.get();
  const tData = tSnap.data();
  
  const itemTransf = {...item};
  delete itemTransf.estado; delete itemTransf.localizacao; delete itemTransf.nomeAjudante;
  if(!tData.itens) tData.itens = [];
  tData.itens.push(itemTransf);

  await targetRef.update({ itens: tData.itens });
  heroiAtivo.itens.splice(idx, 1);
  await db.collection("personagens").doc(heroiAtivo.id).update({ itens: heroiAtivo.itens });

  fecharModal('modal-transferir');
  renderTudo();
}

async function criarHeroi() {
  const p = {
    nome: document.getElementById('n-nome').value,
    senha: document.getElementById('n-senha').value,
    nivel: 1, 
    forca: Number(document.getElementById('n-for').value) || 0,
    pvMax: Number(document.getElementById('n-pv').value) || 20,
    pv: Number(document.getElementById('n-pv').value) || 20,
    pmMax: Number(document.getElementById('n-pm').value) || 10,
    pm: Number(document.getElementById('n-pm').value) || 10,
    defesaBase: Number(document.getElementById('n-def').value) || 10,
    defesaAtual: Number(document.getElementById('n-def').value) || 10,
    tibares: Number(document.getElementById('n-tib').value) || 0,
    preparaMagias: document.getElementById('n-prepara').value === 'sim',
    magias: [], magiasPreparadas: [], itens: []
  };
  if(!p.nome || !p.senha) return alert("Preencha o nome e a senha obrigat√≥rios!");
  await db.collection("personagens").add(p);
  location.reload();
}

async function abrirCompendio() { abrirModal('modal-compendio'); document.getElementById('titulo-compendio').innerText = "üìñ Biblioteca Global"; carregarGlobal('magias_globais', 'magia'); }
async function abrirArsenal() { abrirModal('modal-compendio'); document.getElementById('titulo-compendio').innerText = "‚öîÔ∏è Arsenal Global"; carregarGlobal('itens_globais', 'item'); }

async function carregarGlobal(col, type) {
  document.getElementById('subtitulo-compendio').innerText = "Base de dados compartilhada. Clique no card para ver detalhes.";
  const snap = await db.collection(col).orderBy('nome').get();
  const lista = document.getElementById('lista-compendio'); 
  lista.innerHTML = "";
  
  let i = 0;
  snap.forEach(doc => {
    i++;
    const m = doc.data();
    const dropId = `drop-global-${i}`;
    
    // Regra Visualiza√ß√£o pelo Mestre (Sanfona): exibe descri√ß√£o completa no BD
    let txtAprimora = '';
    if (m.aprimora) txtAprimora = formatarAprimoramento(m.aprimora);

    let infoDetalhe = [];
    if(m.execucao) infoDetalhe.push(`<b>Exec:</b> ${m.execucao}`);
    if(m.alcance) infoDetalhe.push(`<b>Alc:</b> ${m.alcance}`);
    if(m.duracao) infoDetalhe.push(`<b>Dur:</b> ${m.duracao}`);
    const divInfo = infoDetalhe.length > 0 ? `<div style="font-size:0.85em; background:#eee; padding:5px; border-radius:4px; margin-bottom:8px;">${infoDetalhe.join(' ‚Ä¢ ')}</div>` : '';

    lista.innerHTML += `
    <div style="background:white; margin-bottom:8px; border-radius:8px; border:1px solid #ddd; overflow:hidden;">
      <div style="padding:12px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="document.getElementById('${dropId}').style.display = document.getElementById('${dropId}').style.display === 'block' ? 'none' : 'block'">
        <div><b>${m.nome}</b><br><small>${m.categoria ? categoriasNomes[m.categoria] : (m.escola || '')}</small></div>
        <button class="aba-btn ativa" style="padding:5px" onclick='aprenderGlobal(${JSON.stringify(m)}, "${type}"); event.stopPropagation();'>+ Adicionar</button>
      </div>
      <div id="${dropId}" style="display:none; padding:15px; border-top:1px solid #eee; background-color:#fffbf0; font-size:0.95em; color:#3e2723;">
         ${divInfo}
         <p style="margin-top:0;">${m.desc || 'Sem descri√ß√£o cadastrada.'}</p>
         ${txtAprimora}
      </div>
    </div>`;
  });
}

async function aprenderGlobal(obj, tipo) {
  if(!heroiAtivo) return alert("Somente acessando a ficha de um personagem para adicionar algo a ela!");
  const novo = {...obj};
  if(tipo === 'magia') heroiAtivo.magias.push(novo);
  else heroiAtivo.itens.push(novo);
  await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo);
  alert("Adicionado com sucesso!"); renderTudo();
}

async function deletarPersonagem(id, nome) { if(confirm("Deletar " + nome + "?")) await db.collection("personagens").doc(id).delete(); }

async function salvarEdicaoPerfil() {
  heroiAtivo.nome = document.getElementById('e-nome').value;
  heroiAtivo.nivel = Number(document.getElementById('e-nv').value);
  heroiAtivo.pvMax = Number(document.getElementById('e-pv-max').value);
  heroiAtivo.pmMax = Number(document.getElementById('e-pm-max').value);
  heroiAtivo.forca = Number(document.getElementById('e-for').value);
  heroiAtivo.defesaBase = Number(document.getElementById('e-def-base').value);
  if(heroiAtivo.defesaAtual === undefined) heroiAtivo.defesaAtual = heroiAtivo.defesaBase;
  heroiAtivo.tibares = Number(document.getElementById('e-tib').value);
  heroiAtivo.preparaMagias = document.getElementById('e-prepara').value === 'sim';

  await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo);
  fecharModal('modal-editar-perfil');
}

function abrirModal(id) {
  if(id === 'modal-item') {
    document.getElementById('modal-titulo').innerText = "Novo Registro";
    document.getElementById('div-enviar-arsenal').style.display = 'flex';
    limparFormularioItem(); // Garante o formul√°rio limpo ao abrir 
  }
  if(id === 'modal-editar-perfil' && heroiAtivo) {
    document.getElementById('e-nome').value = heroiAtivo.nome;
    document.getElementById('e-nv').value = heroiAtivo.nivel;
    document.getElementById('e-pv-max').value = heroiAtivo.pvMax;
    document.getElementById('e-pm-max').value = heroiAtivo.pmMax;
    document.getElementById('e-for').value = heroiAtivo.forca;
    document.getElementById('e-def-base').value = heroiAtivo.defesaBase || 10;
    document.getElementById('e-tib').value = heroiAtivo.tibares;
    document.getElementById('e-prepara').value = heroiAtivo.preparaMagias ? 'sim' : 'nao';
  }
  document.getElementById(id).style.display = 'flex';
}

function fecharModal(id) { document.getElementById(id).style.display = 'none'; }
function abrirCalculadora(c, t) { campoAtual = c; document.getElementById('calc-input').value = ""; document.getElementById('calc-titulo').innerText = t; abrirModal('modal-calculadora'); }
function mudarAba(aba) {
  document.getElementById('conteudo-grimorio').style.display = aba === 'grimorio' ? 'block' : 'none';
  document.getElementById('conteudo-inventario').style.display = aba === 'inventario' ? 'block' : 'none';
  document.getElementById('conteudo-preparadas').style.display = aba === 'preparadas' ? 'block' : 'none';
  document.getElementById('btn-aba-g').classList.toggle('ativa', aba === 'grimorio');
  document.getElementById('btn-aba-i').classList.toggle('ativa', aba === 'inventario');
  document.getElementById('btn-aba-p').classList.toggle('ativa', aba === 'preparadas');
}
function toggleMagia(i) { const el = document.getElementById(`magia-info-${i}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
async function removerAlgo(c, i) { if(confirm("Remover permanentemente?")) { heroiAtivo[c].splice(i, 1); await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo); } }
function ajustarCampos() {
  document.getElementById('campos-magia').style.display = document.getElementById('tipo-registro').value === 'magia' ? 'block' : 'none';
  document.getElementById('campos-item').style.display = document.getElementById('tipo-registro').value === 'item' ? 'block' : 'none';
}
async function carregarListaJogadores() {
  const snap = await db.collection("personagens").get();
  const div = document.getElementById('lista-jogadores-login'); div.innerHTML = "";
  if(snap.empty) div.innerHTML = "<p>Nenhum her√≥i registrado.</p>";
  snap.forEach(doc => div.innerHTML += `<button class="btn-grande" style="background:white;color:#3e2723" onclick="idTemp='${doc.id}';abrirModal('modal-login-jogador');"><b>${doc.data().nome}</b></button>`);
}
</script>
</body>
</html>