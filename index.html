<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bag of Holding | Tormenta20 System Manager</title>
    <style>
        /* =========================================
           VARI√ÅVEIS GLOBAIS E TEMA
           ========================================= */
        :root {
            --cor-fundo: #eaddca; 
            --cor-borda: #5d4037; 
            --cor-detalhe: #8d2b2b; 
            --cor-texto: #3e2723; 
            
            /* Cores de Status */
            --cor-pv: #c62828; 
            --cor-pm: #1565c0; 
            --cor-def: #455a64;
            --cor-tibares: #d4af37;

            /* Tipografia */
            --fonte-titulo: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            --fonte-padrao: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* =========================================
           RESET E ESTRUTURA B√ÅSICA
           ========================================= */
        body { 
            background-color: #1a1210; 
            color: var(--cor-texto); 
            font-family: var(--fonte-padrao); 
            margin: 0; 
            padding-bottom: 120px; /* Espa√ßo para bot√£o flutuante */
            overflow-x: hidden; 
        }

        h1, h2, h3 { 
            font-family: var(--fonte-titulo); 
            color: var(--cor-borda); 
            text-transform: uppercase; 
            text-align: center; 
            margin-top: 0; 
            letter-spacing: 1px;
        }

        /* =========================================
           CONTAINER PRINCIPAL (TELAS)
           ========================================= */
        .tela { 
            display: none; 
            width: 95%; 
            max-width: 800px; 
            margin: 30px auto; 
            background: var(--cor-fundo); 
            border: 4px solid var(--cor-borda); 
            border-radius: 15px; 
            padding: 25px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); 
            position: relative; 
            box-sizing: border-box; 
        }

        /* Anima√ß√£o suave ao abrir telas */
        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           COMPONENTES: BOT√ïES
           ========================================= */
        .btn-grande { 
            background: var(--cor-borda); 
            color: white; 
            border: none; 
            padding: 16px; 
            margin: 10px 0; 
            cursor: pointer; 
            border-radius: 8px; 
            width: 100%; 
            font-weight: bold; 
            text-transform: uppercase; 
            box-shadow: 0 4px 0 #2d1d1a; 
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-grande:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-sair { 
            background: #d32f2f !important; 
            color: white !important; 
            padding: 8px 18px !important; 
            border-radius: 6px !important; 
            border: none !important; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .btn-add { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            width: 75px; 
            height: 75px; 
            background: var(--cor-detalhe); 
            color: white; 
            border-radius: 50%; 
            border: 4px solid #fff; 
            font-size: 45px; 
            cursor: pointer; 
            z-index: 100; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 8px; /* Ajuste visual do + */
        }

        /* =========================================
           COMPONENTES: INPUTS E FORMUL√ÅRIOS
           ========================================= */
        input, textarea, select { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 2px solid #bcaaa4; 
            background: #fdfaf3; 
            box-sizing: border-box; 
            font-weight: bold; 
            font-size: 1em;
            color: var(--cor-texto);
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--cor-detalhe);
            background: #fff;
        }

        /* =========================================
           DASHBOARD JOGADOR (STATUS)
           ========================================= */
        .status-container-pro { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            margin: 25px 0; 
        }

        .status-hero-card { 
            display: grid; 
            grid-template-columns: 80px 1fr 100px; 
            align-items: center; 
            background: #fff; 
            border-radius: 12px; 
            padding: 15px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            border-left: 12px solid var(--cor-borda); 
            cursor: pointer; 
            transition: transform 0.2s; 
        }

        .status-hero-card:active { transform: scale(0.98); }

        /* Varia√ß√µes de cores dos cards */
        .card-pv { border-left-color: var(--cor-pv); background: linear-gradient(to right, #fff, #ffebee); }
        .card-pm { border-left-color: var(--cor-pm); background: linear-gradient(to right, #fff, #e3f2fd); }
        .card-def { border-left-color: var(--cor-def); background: linear-gradient(to right, #fff, #eceff1); }

        .status-label { 
            font-weight: 800; 
            font-size: 0.85em; 
            color: #666; 
            text-transform: uppercase;
        }

        .status-main-val { 
            font-size: 2.8em; 
            font-weight: 900; 
            text-align: center; 
            font-family: var(--fonte-titulo); 
            line-height: 1; 
        }

        .status-sub-info { 
            text-align: right; 
            font-weight: bold; 
            font-size: 0.9em; 
            opacity: 0.8; 
        }

        .tibares-card { 
            background: var(--cor-tibares); 
            color: #3e2723; 
            margin: 15px 0; 
            padding: 18px; 
            border-radius: 10px; 
            text-align: center; 
            font-weight: 900; 
            cursor: pointer; 
            border: 2px solid #b8860b; 
            font-size: 1.3em; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* =========================================
           PAINEL DO MESTRE (MONITOR)
           ========================================= */
        #grid-mestre { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 20px; 
        }

        .monitor-mestre-card { 
            background: #fff; 
            border-radius: 12px; 
            padding: 18px; 
            border: 2px solid var(--cor-borda); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
            position: relative;
        }

        .monitor-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 8px; 
        }

        /* Barras de Progresso do Mestre */
        .monitor-bar-bg { 
            background: #e0e0e0; 
            height: 26px; 
            border-radius: 13px; 
            margin: 12px 0; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid #999; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .monitor-bar-fill { 
            height: 100%; 
            transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1); 
        }

        .bar-label { 
            position: absolute; 
            width: 100%; 
            text-align: center; 
            font-size: 0.9em; 
            font-weight: 900; 
            color: #000; 
            line-height: 26px; 
            text-shadow: 0 0 5px #fff; 
            left: 0;
            top: 0;
            z-index: 2;
        }

        /* =========================================
           SISTEMA DE ABAS E CONTE√öDO
           ========================================= */
        .abas { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            border-bottom: 2px solid var(--cor-borda);
            padding-bottom: 10px;
        }

        .aba-btn { 
            flex: 1; 
            background: #d7ccc8; 
            border: 2px solid var(--cor-borda); 
            padding: 14px; 
            cursor: pointer; 
            font-weight: bold; 
            border-radius: 10px 10px 0 0; 
            opacity: 0.7;
            transition: 0.3s;
        }

        .aba-btn.ativa { 
            background: var(--cor-borda); 
            color: white; 
            opacity: 1;
            transform: translateY(2px);
        }

        /* Estilo para lista de itens/magias */
        .magia-container { 
            margin-bottom: 15px; 
            border: 2px solid var(--cor-borda); 
            border-radius: 10px; 
            overflow: hidden; 
            background: #fff; 
        }

        .magia-header-click { 
            background: var(--cor-detalhe); 
            color: #f4e4bc; 
            padding: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
        }

        .magia-conteudo-oculto {
            display: none;
            padding: 20px;
            line-height: 1.6;
            border-top: 1px solid #ccc;
            background-color: #fffbf0;
        }

        /* =========================================
           MODAIS (Pop-ups)
           ========================================= */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(4px);
            z-index: 2000; 
            justify-content: center; 
            align-items: center; 
            padding: 15px; 
        }

        .modal-content { 
            background: var(--cor-fundo); 
            padding: 30px; 
            border: 5px solid var(--cor-borda); 
            width: 100%; 
            max-width: 550px; 
            border-radius: 20px; 
            max-height: 85vh; 
            overflow-y: auto; 
            box-sizing: border-box; 
            animation: popIn 0.3s;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

    </style>
</head>
<body>

    <div id="tela-login" class="tela fade-in" style="display: block;">
        <h1 style="font-size: 2.5em; margin-bottom: 10px;">üéí Bag of Holding</h1>
        <p style="text-align: center; color: var(--cor-detalhe); margin-bottom: 30px; font-weight: bold;">
            Gerenciador Oficial Tormenta20
        </p>

        <button class="btn-grande" onclick="abrirModal('modal-login-mestre')">
            üìú Painel do Mestre
        </button>
        
        <button class="btn-grande" style="background:#4a6572" onclick="carregarListaJogadores()">
            üë§ Entrar como Her√≥i
        </button>
        
        <div id="lista-jogadores-login" style="margin-top: 25px; display: grid; gap: 10px;">
            </div>

        <div style="text-align: center; margin-top: 30px;">
            <button onclick="abrirModal('modal-criar')" style="background:none; border:none; color:var(--cor-detalhe); cursor:pointer; text-decoration:underline; font-weight:bold; font-size: 1.1em;">
                ‚ú® Criar Novo Her√≥i
            </button>
        </div>
    </div>

    <div id="tela-mestre" class="tela fade-in">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--cor-borda); padding-bottom: 10px;">
            <h2 style="margin:0">üìú Monitor da Mesa</h2>
            <button class="btn-sair" onclick="deslogar()">Sair</button>
        </div>

        <button class="btn-grande" style="background:#8d2b2b" onclick="abrirCompendio()">
            ‚öôÔ∏è Gerenciar Biblioteca Global
        </button>
        
        <div id="grid-mestre">
            </div>
    </div>

    <div id="tela-mochila" class="tela fade-in">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <div>
                <h1 id="nome-exibicao" style="margin:0; text-align: left; font-size: 2em;">Her√≥i</h1>
                <small id="sub-nome" style="color:var(--cor-detalhe); font-weight: bold; font-size: 1.2em;">N√≠vel 1</small>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="abrirModal('modal-editar-perfil')" title="Configura√ß√µes" style="background:none; border:none; font-size:30px; cursor:pointer;">‚öôÔ∏è</button>
                <button class="btn-sair" onclick="deslogar()">Trocar</button>
            </div>
        </div>

        <div class="tibares-card" onclick="abrirCalculadora('tibares', 'üí∞ Alterar Tibares')">
            üí∞ <span id="stat-tib">0</span> T$
        </div>

        <div class="status-container-pro">
            <div class="status-hero-card card-pv" onclick="abrirCalculadora('pv', '‚ù§Ô∏è Alterar Vida')">
                <span class="status-label" style="color:var(--cor-pv)">VIDA (PV)</span>
                <span class="status-main-val" id="v-pv" style="color:var(--cor-pv)">0</span>
                <span class="status-sub-info">M√ÅX: <span id="v-pv-max">0</span></span>
            </div>

            <div class="status-hero-card card-pm" onclick="abrirCalculadora('pm', 'ü™Ñ Alterar Mana')">
                <span class="status-label" style="color:var(--cor-pm)">MANA (PM)</span>
                <span class="status-main-val" id="v-pm" style="color:var(--cor-pm)">0</span>
                <span class="status-sub-info">M√ÅX: <span id="v-pm-max">0</span></span>
            </div>

            <div class="status-hero-card card-def" onclick="abrirCalculadora('defesa', 'üõ°Ô∏è Alterar Defesa')">
                <span class="status-label" style="color:var(--cor-def)">DEFESA</span>
                <span class="status-main-val" id="v-def" style="color:var(--cor-def)">0</span>
                <span class="status-sub-info">PASSIVA</span>
            </div>
        </div>

        <nav class="abas">
            <button class="aba-btn ativa" id="btn-aba-g" onclick="mudarAba('grimorio')">üìñ Grim√≥rio</button>
            <button class="aba-btn" id="btn-aba-i" onclick="mudarAba('inventario')">üéí Invent√°rio</button>
        </nav>

        <div id="conteudo-grimorio">
            <button class="btn-grande" style="background:#4a6572; font-size:0.9em; padding: 12px;" onclick="abrirCompendio()">
                üìñ Consultar Biblioteca Global
            </button>
            <div id="magias-lista"></div>
        </div>

        <div id="conteudo-inventario" style="display:none">
            <div id="barra-carga" style="background:var(--cor-borda); color:white; padding:15px; border-radius:10px; text-align:center; margin-bottom:15px; font-weight:bold; box-shadow: inset 0 0 10px rgba(0,0,0,0.3);">
                </div>
            <div id="itens-lista"></div>
        </div>
        
        <button id="btn-mestre-voltar" style="display:none; background:#d32f2f; margin-top: 30px;" class="btn-grande" onclick="mostrarPainelMestre()">
            ‚¨Ö VOLTAR AO MONITOR
        </button>
    </div>

    <div id="modal-calculadora" class="modal"><div class="modal-content">
        <h3 id="calc-titulo">Modificar Valor</h3>
        <p style="text-align:center; color:#666">Use valores negativos (ex: -5) para reduzir.</p>
        <input type="number" id="calc-input" placeholder="Digite o valor" autofocus>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn-grande" style="background:#2e7d32" onclick="aplicarCalculo()">Confirmar</button>
            <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-calculadora')">Cancelar</button>
        </div>
    </div></div>

    <div id="modal-editar-perfil" class="modal"><div class="modal-content">
        <h3>‚öôÔ∏è Editar Ficha</h3>
        <label>Nome do Personagem</label>
        <input type="text" id="e-nome">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><label>N√≠vel</label><input type="number" id="e-nv"></div>
            <div><label>For√ßa (Carga)</label><input type="number" id="e-for"></div>
            <div><label>PV M√°ximo</label><input type="number" id="e-pv-max"></div>
            <div><label>PM M√°ximo</label><input type="number" id="e-pm-max"></div>
            <div><label>Defesa Total</label><input type="number" id="e-def"></div>
            <div><label>Tibares (Ouro)</label><input type="number" id="e-tib"></div>
        </div>
        
        <button class="btn-grande" onclick="salvarEdicaoPerfil()">Salvar Altera√ß√µes</button>
        <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-editar-perfil')">Fechar</button>
    </div></div>

    <div id="modal-item" class="modal"><div class="modal-content">
        <h3 id="modal-titulo">Novo Registro</h3>
        <input type="hidden" id="edit-id-global">
        
        <select id="tipo-registro" onchange="ajustarCampos()">
            <option value="magia"> ‚ú® Magia / Habilidade</option>
            <option value="item"> ‚öîÔ∏è Item / Equipamento</option>
        </select>
        
        <input type="text" id="nome-reg" placeholder="Nome do Registro">
        
        <div id="campos-magia">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="m-escola" placeholder="Escola (Ex: Evoca√ß√£o)">
                <input type="text" id="m-circulo" placeholder="C√≠rculo/Custo">
            </div>
            <textarea id="m-aprimora" placeholder="Aprimoramentos e Custos Extras..." rows="3"></textarea>
        </div>
        
        <textarea id="desc-reg" placeholder="Descri√ß√£o detalhada do efeito ou item..." rows="5"></textarea>
        
        <div id="campos-item" style="display:none">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="number" id="i-peso" placeholder="Peso (kg)" value="0">
                <input type="number" id="i-qtd" placeholder="Quantidade" value="1">
            </div>
        </div>
        
        <button class="btn-grande" onclick="salvarNovo()">Salvar e Adicionar</button>
        <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-item')">Voltar</button>
    </div></div>

    <div id="modal-login-jogador" class="modal"><div class="modal-content">
        <h3 id="txt-login-nome">Login</h3>
        <input type="password" id="pass-jogador" placeholder="Senha da Ficha">
        <button class="btn-grande" onclick="validarJogador(false)">Acessar Ficha</button>
        <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-login-jogador')">Voltar</button>
    </div></div>

    <div id="modal-login-mestre" class="modal"><div class="modal-content">
        <h3>Acesso do Mestre</h3>
        <input type="password" id="pass-mestre" placeholder="Senha do Mestre">
        <button class="btn-grande" onclick="validarMestre()">Entrar no Monitor</button>
        <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-login-mestre')">Voltar</button>
    </div></div>

    <div id="modal-criar" class="modal"><div class="modal-content">
        <h3>Forjar Novo Her√≥i</h3>
        <p style="color:#666; text-align:center">Preencha os dados iniciais.</p>
        <input type="text" id="n-nome" placeholder="Nome do Personagem">
        <input type="password" id="n-senha" placeholder="Crie uma Senha">
        <button class="btn-grande" onclick="criarHeroi()">Criar Ficha</button>
        <button class="btn-grande" style="background:#555" onclick="fecharModal('modal-criar')">Cancelar</button>
    </div></div>

    <div id="modal-compendio" class="modal"><div class="modal-content">
        <h3>üìñ Biblioteca Global</h3>
        <p style="text-align:center; font-size:0.9em; color:#555">Base de dados compartilhada entre todos.</p>
        <div id="lista-compendio" style="max-height: 400px; overflow-y: auto;"></div>
        <button class="btn-grande" onclick="fecharModal('modal-compendio')">Fechar</button>
    </div></div>

    <button class="btn-add" id="btn-flutuante" style="display:none" onclick="abrirModal('modal-item')">+</button>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // CONFIGURA√á√ÉO DO FIREBASE (N√ÉO ALTERAR CHAVES)
        const firebaseConfig = { 
            apiKey: "AIzaSyCwv-I1QdEZJlAJAMX4aOvGxaCRRQiHGM8", 
            authDomain: "mochila-548a0.firebaseapp.com", 
            projectId: "mochila-548a0", 
            storageBucket: "mochila-548a0.firebasestorage.app", 
            messagingSenderId: "823862724587", 
            appId: "1:823862724587:web:d452ced78e9848e4f8fbae" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ESTADO DA APLICA√á√ÉO
        let heroiAtivo = null;     // Dados do personagem logado
        let idTemp = null;         // ID tempor√°rio para transi√ß√µes
        let campoAtual = '';       // Qual campo est√° sendo editado na calculadora
        let modoMestreAtivo = false; // Flag de permiss√£o de mestre
        let listenerHeroi = null;  // Para cancelar o "ouvinte" em tempo real ao sair

        // ------------------------------------------------------------------
        // FUN√á√ÉO PRINCIPAL: RENDERIZA√á√ÉO DA FICHA
        // ------------------------------------------------------------------
        function renderTudo() {
            if(!heroiAtivo) return;

            // Dados B√°sicos
            document.getElementById('nome-exibicao').innerText = heroiAtivo.nome;
            document.getElementById('sub-nome').innerText = `N√≠vel ${heroiAtivo.nivel}`;
            document.getElementById('stat-tib').innerText = (heroiAtivo.tibares || 0).toLocaleString();
            
            // Status Principais
            document.getElementById('v-pv').innerText = heroiAtivo.pv;
            document.getElementById('v-pv-max').innerText = heroiAtivo.pvMax;
            
            document.getElementById('v-pm').innerText = heroiAtivo.pm;
            document.getElementById('v-pm-max').innerText = heroiAtivo.pmMax;
            
            document.getElementById('v-def').innerText = heroiAtivo.defesa;
            
            // Renderizar Magias
            const g = document.getElementById('magias-lista'); 
            g.innerHTML = "";
            (heroiAtivo.magias || []).forEach((m, idx) => {
                g.innerHTML += `
                    <div class="magia-container">
                        <div class="magia-header-click" onclick="toggleMagia(${idx})">
                            <div>
                                <b style="font-size:1.1em">${m.nome}</b><br>
                                <small style="opacity:0.9">${m.escola} ${m.circulo ? ' - ' + m.circulo : ''}</small>
                            </div>
                            <button onclick="removerAlgo('magias', ${idx}); event.stopPropagation();" style="background:none;border:none;color:white;font-size:20px;cursor:pointer">üóëÔ∏è</button>
                        </div>
                        <div id="magia-info-${idx}" class="magia-conteudo-oculto">
                            <p style="margin-top:0">${m.desc}</p>
                            ${m.aprimora ? `<div style="background:#fdfaf3;padding:10px;border-left:4px solid var(--cor-detalhe);font-style:italic;margin-top:10px">‚ú® ${m.aprimora}</div>` : ''}
                        </div>
                    </div>`;
            });

            // Renderizar Invent√°rio e Carga
            const iL = document.getElementById('itens-lista'); 
            iL.innerHTML = "";
            let carga = 0;
            (heroiAtivo.itens || []).forEach((it, idx) => {
                const pesoTotal = (Number(it.peso) * Number(it.qtd));
                carga += pesoTotal;
                iL.innerHTML += `
                    <div style="background:white;padding:15px;margin-bottom:10px;border-radius:10px;display:flex;justify-content:space-between;border:1px solid #ddd; align-items:center;">
                        <div>
                            <b style="font-size:1.1em">${it.nome}</b> <br>
                            <span style="color:#666">${it.qtd}x ‚Ä¢ ${it.peso}kg un.</span>
                        </div>
                        <button onclick="removerAlgo('itens', ${idx})" style="color:#d32f2f;border:none;background:none;font-size:22px;cursor:pointer">üóëÔ∏è</button>
                    </div>`;
            });
            
            const capMax = 10 + (2 * heroiAtivo.forca); // Regra Tormenta20 (3kg base + 2*FOR? Ajustei para padr√£o comum)
            document.getElementById('barra-carga').innerText = `Carga Atual: ${carga.toFixed(1)}kg / M√°x: ${capMax}kg`;
            
            // Alerta visual de sobrecarga
            document.getElementById('barra-carga').style.background = carga > capMax ? '#d32f2f' : 'var(--cor-borda)';
        }

        // ------------------------------------------------------------------
        // CONTROLE DE ACESSO E LOGOUT
        // ------------------------------------------------------------------
        function deslogar() {
            // Cancelar listener se existir para economizar dados
            if(listenerHeroi) {
                listenerHeroi(); // Fun√ß√£o retornada pelo onSnapshot cancela a escuta
                listenerHeroi = null;
            }

            heroiAtivo = null; 
            modoMestreAtivo = false;
            
            document.querySelectorAll('.tela').forEach(t => t.style.display = 'none');
            document.getElementById('tela-login').style.display = 'block';
            document.getElementById('btn-flutuante').style.display = 'none';
        }

        async function validarJogador(viaMestre) {
            // Se for via mestre, n√£o pede senha. Se for jogador, verifica senha.
            const docRef = db.collection("personagens").doc(idTemp);
            const doc = await docRef.get();
            
            if (!doc.exists) { alert("Personagem n√£o encontrado."); return; }

            if(viaMestre || doc.data().senha === document.getElementById('pass-jogador').value) {
                // ATIVA√á√ÉO DO LISTENER EM TEMPO REAL (NOVIDADE)
                // Isso garante que o jogador veja mudan√ßas feitas pelo mestre instantaneamente
                listenerHeroi = docRef.onSnapshot((snapshot) => {
                    if (snapshot.exists) {
                        heroiAtivo = { id: snapshot.id, ...snapshot.data() };
                        renderTudo();
                    } else {
                        // Se o personagem foi deletado enquanto logado
                        alert("Este personagem foi removido.");
                        deslogar();
                    }
                });

                fecharModal('modal-login-jogador');
                document.querySelectorAll('.tela').forEach(t => t.style.display = 'none');
                document.getElementById('tela-mochila').style.display = 'block';
                document.getElementById('btn-flutuante').style.display = 'block';
                document.getElementById('btn-mestre-voltar').style.display = modoMestreAtivo ? 'block' : 'none';
            } else {
                alert("Senha da ficha incorreta!");
            }
        }

        // ------------------------------------------------------------------
        // PAINEL DO MESTRE
        // ------------------------------------------------------------------
        async function validarMestre() { 
            if(document.getElementById('pass-mestre').value === "mestre123") { 
                modoMestreAtivo = true; 
                fecharModal('modal-login-mestre'); 
                mostrarPainelMestre(); 
            } else alert("Senha do mestre inv√°lida!");
        }

        function mostrarPainelMestre() {
            // Remove listener do her√≥i se estava aberto
            if(listenerHeroi) { listenerHeroi(); listenerHeroi = null; }

            document.querySelectorAll('.tela').forEach(t => t.style.display = 'none');
            document.getElementById('tela-mestre').style.display = 'block';
            
            // Listener global para todos os personagens
            db.collection("personagens").onSnapshot(snap => {
                const grid = document.getElementById('grid-mestre'); 
                grid.innerHTML = "";
                snap.forEach(doc => {
                    const h = doc.data();
                    const perPV = Math.min((h.pv / h.pvMax) * 100, 100);
                    const perPM = Math.min((h.pm / h.pmMax) * 100, 100);
                    
                    grid.innerHTML += `
                        <div class="monitor-mestre-card">
                            <div class="monitor-header">
                                <b>${h.nome} <span style="color:#666; font-size:0.8em">(Nv ${h.nivel})</span></b>
                                <div style="display:flex; gap:5px;">
                                    <button onclick="idTemp='${doc.id}'; validarJogador(true)" style="background:var(--cor-borda);color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-weight:bold">ABRIR</button>
                                    <button onclick="deletarPersonagem('${doc.id}', '${h.nome}')" style="background:#d32f2f;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-weight:bold">X</button>
                                </div>
                            </div>
                            
                            <div class="monitor-bar-bg">
                                <div class="monitor-bar-fill" style="width:${perPV}%; background:var(--cor-pv)"></div>
                                <div class="bar-label">${h.pv} / ${h.pvMax} PV</div>
                            </div>
                            
                            <div class="monitor-bar-bg">
                                <div class="monitor-bar-fill" style="width:${perPM}%; background:var(--cor-pm)"></div>
                                <div class="bar-label">${h.pm} / ${h.pmMax} PM</div>
                            </div>
                            
                            <div style="font-size:0.85em; font-weight:bold; margin-top:10px; display:flex; justify-content:space-between; background:#f5f5f5; padding:8px; border-radius:5px;">
                                <span>üõ°Ô∏è Defesa: ${h.defesa}</span>
                                <span>üí∞ T$: ${h.tibares}</span>
                            </div>
                        </div>`;
                });
            });
        }

        // ------------------------------------------------------------------
        // OPERA√á√ïES DE DADOS (CRUD)
        // ------------------------------------------------------------------
        async function aplicarCalculo() {
            const val = Number(document.getElementById('calc-input').value);
            if(isNaN(val)) return;

            heroiAtivo[campoAtual] += val;
            
            // Travas l√≥gicas (n√£o passar do m√°ximo)
            if(campoAtual === 'pv' && heroiAtivo.pv > heroiAtivo.pvMax) heroiAtivo.pv = heroiAtivo.pvMax;
            if(campoAtual === 'pm' && heroiAtivo.pm > heroiAtivo.pmMax) heroiAtivo.pm = heroiAtivo.pmMax;
            
            await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo);
            fecharModal('modal-calculadora'); 
            // RenderTudo ser√° chamado automaticamente pelo listener
        }

        async function salvarNovo() {
            const tipo = document.getElementById('tipo-registro').value;
            const globalId = document.getElementById('edit-id-global').value;
            
            const d = { 
                nome: document.getElementById('nome-reg').value, 
                desc: document.getElementById('desc-reg').value 
            };

            if(!d.nome) return alert("O nome √© obrigat√≥rio!");

            if (tipo === 'magia') {
                d.escola = document.getElementById('m-escola').value; 
                d.circulo = document.getElementById('m-circulo').value; 
                d.aprimora = document.getElementById('m-aprimora').value;
                
                // L√≥gica H√≠brida: Salvar Global ou Local?
                if (globalId) {
                    await db.collection("magias_globais").doc(globalId).update(d);
                } else { 
                    // Se estiver num her√≥i, salva local. Se estiver no modo mestre editando, salva global.
                    // O fluxo atual prioriza salvar no her√≥i se a modal foi aberta pelo bot√£o flutuante.
                    // Ajuste: Se o modal tem flag global, vai pro global.
                    if(document.getElementById('modal-titulo').innerText.includes("Biblioteca")) {
                         await db.collection("magias_globais").add(d);
                    } else if(heroiAtivo) {
                         heroiAtivo.magias.push(d);
                    }
                }
            } else { 
                // Itens (Sempre local por enquanto)
                d.peso = Number(document.getElementById('i-peso').value); 
                d.qtd = Number(document.getElementById('i-qtd').value); 
                if(heroiAtivo) heroiAtivo.itens.push(d); 
            }

            if(heroiAtivo) await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo);
            
            fecharModal('modal-item'); 
            if(modoMestreAtivo && document.getElementById('modal-titulo').innerText.includes("Biblioteca")) abrirCompendio();
        }

        async function carregarListaJogadores() {
            const snap = await db.collection("personagens").get();
            const div = document.getElementById('lista-jogadores-login'); div.innerHTML = "";
            if(snap.empty) { div.innerHTML = "<p style='text-align:center'>Nenhum her√≥i encontrado.</p>"; }
            
            snap.forEach(doc => { 
                div.innerHTML += `
                <button class="btn-grande" style="background:white; color:var(--cor-texto); border:2px solid var(--cor-borda)" 
                    onclick="idTemp='${doc.id}'; abrirModal('modal-login-jogador'); document.getElementById('txt-login-nome').innerText='Acessar: ${doc.data().nome}'">
                    <b>${doc.data().nome}</b> <span style="font-size:0.8em">(Nv ${doc.data().nivel})</span>
                </button>`; 
            });
        }

        async function criarHeroi() {
            const p = { 
                nome: document.getElementById('n-nome').value, 
                senha: document.getElementById('n-senha').value, 
                nivel: 1, 
                forca: 0, 
                pvMax: 20, pv: 20, 
                pmMax: 10, pm: 10, 
                defesa: 10, tibares: 0, 
                magias: [], itens: [] 
            };
            if(!p.nome || !p.senha) return alert("Preencha nome e senha!");
            await db.collection("personagens").add(p); 
            location.reload();
        }

        async function deletarPersonagem(id, nome) {
            if(confirm(`ATEN√á√ÉO MESTRE:\nTem certeza que deseja DELETAR PERMANENTEMENTE a ficha de "${nome}"?\nIsso n√£o pode ser desfeito.`)) {
                await db.collection("personagens").doc(id).delete();
                // O listener do mestre atualizar√° a tela automaticamente
            }
        }

        // ------------------------------------------------------------------
        // COMP√äNDIO / BIBLIOTECA
        // ------------------------------------------------------------------
        async function abrirCompendio() {
            abrirModal('modal-compendio');
            const snap = await db.collection("magias_globais").orderBy('nome').get();
            const lista = document.getElementById('lista-compendio'); 
            lista.innerHTML = "";
            
            snap.forEach(doc => {
                const m = doc.data(); const id = doc.id;
                let btns = `<button class="aba-btn ativa" style="padding:5px 10px; font-size:0.8em" onclick='aprenderMagia(${JSON.stringify(m)})'>+ Aprender</button>`;
                
                if(modoMestreAtivo) {
                    btns = `
                    <button onclick='editarMagiaGlobal("${id}", ${JSON.stringify(m)})' style="background:#4a6572;color:white;padding:8px;border:none;border-radius:4px;cursor:pointer">‚úèÔ∏è</button> 
                    <button onclick='apagarMagiaGlobal("${id}")' style="background:#d32f2f;color:white;padding:8px;border:none;border-radius:4px;cursor:pointer;margin-left:5px">üóëÔ∏è</button>`;
                }

                lista.innerHTML += `
                <div style="background:white;padding:12px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <b>${m.nome}</b>
                        <div>${btns}</div>
                    </div>
                    <small style="color:#666">${m.escola} ${m.circulo ? '- ' + m.circulo : ''}</small>
                    <p style="font-size:0.9em; margin:5px 0">${m.desc}</p>
                </div>`;
            });
        }

        async function aprenderMagia(m) { 
            if(!heroiAtivo) return alert("Voc√™ precisa estar logado!");
            // Remove ID para n√£o linkar com o banco global
            const novaMagia = {...m}; 
            heroiAtivo.magias.push(novaMagia); 
            await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo); 
            alert(`Voc√™ aprendeu ${m.nome}!`);
            renderTudo(); 
        }

        function apagarMagiaGlobal(id) { 
            if(confirm("Remover esta magia da Biblioteca Global para todos?")) { 
                db.collection("magias_globais").doc(id).delete(); 
                setTimeout(abrirCompendio, 500); // Reabre para atualizar
            } 
        }

        function editarMagiaGlobal(id, m) { 
            fecharModal('modal-compendio'); 
            abrirModal('modal-item'); 
            document.getElementById('modal-titulo').innerText = "Editar Biblioteca Global";
            document.getElementById('edit-id-global').value = id; 
            document.getElementById('nome-reg').value = m.nome; 
            document.getElementById('m-escola').value = m.escola; 
            document.getElementById('m-circulo').value = m.circulo; 
            document.getElementById('m-aprimora').value = m.aprimora; 
            document.getElementById('desc-reg').value = m.desc; 
            document.getElementById('tipo-registro').value = 'magia';
            ajustarCampos();
        }

        // ------------------------------------------------------------------
        // UTILIT√ÅRIOS E UI
        // ------------------------------------------------------------------
        async function salvarEdicaoPerfil() {
            heroiAtivo.nome = document.getElementById('e-nome').value; 
            heroiAtivo.nivel = Number(document.getElementById('e-nv').value);
            heroiAtivo.pvMax = Number(document.getElementById('e-pv-max').value); 
            heroiAtivo.pmMax = Number(document.getElementById('e-pm-max').value);
            heroiAtivo.forca = Number(document.getElementById('e-for').value); 
            heroiAtivo.defesa = Number(document.getElementById('e-def').value);
            heroiAtivo.tibares = Number(document.getElementById('e-tib').value);
            await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo);
            fecharModal('modal-editar-perfil'); 
            // RenderTudo ser√° autom√°tico via listener
        }

        function abrirModal(id) { 
            document.getElementById('calc-input').value = ""; // Limpa inputs anteriores
            
            // Popula modal de edi√ß√£o com dados atuais
            if(id === 'modal-editar-perfil' && heroiAtivo) {
                document.getElementById('e-nome').value = heroiAtivo.nome; 
                document.getElementById('e-nv').value = heroiAtivo.nivel;
                document.getElementById('e-pv-max').value = heroiAtivo.pvMax; 
                document.getElementById('e-pm-max').value = heroiAtivo.pmMax;
                document.getElementById('e-for').value = heroiAtivo.forca; 
                document.getElementById('e-def').value = heroiAtivo.defesa;
                document.getElementById('e-tib').value = heroiAtivo.tibares;
            }

            // Reseta modal de item para padr√£o "Novo"
            if(id === 'modal-item') {
                 document.getElementById('modal-titulo').innerText = "Novo Registro";
                 document.getElementById('edit-id-global').value = "";
                 document.getElementById('nome-reg').value = "";
                 document.getElementById('desc-reg').value = "";
            }

            document.getElementById(id).style.display = 'flex'; 
        }

        function fecharModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function abrirCalculadora(campo, titulo) {
            campoAtual = campo;
            document.getElementById('calc-titulo').innerText = titulo;
            abrirModal('modal-calculadora');
        }

        function mudarAba(aba) {
            document.getElementById('conteudo-grimorio').style.display = aba === 'grimorio' ? 'block' : 'none';
            document.getElementById('conteudo-inventario').style.display = aba === 'inventario' ? 'block' : 'none';
            document.getElementById('btn-aba-g').classList.toggle('ativa', aba === 'grimorio');
            document.getElementById('btn-aba-i').classList.toggle('ativa', aba === 'inventario');
        }

        function toggleMagia(idx) { 
            const el = document.getElementById(`magia-info-${idx}`); 
            el.style.display = el.style.display === 'block' ? 'none' : 'block'; 
        }

        async function removerAlgo(c, i) { 
            if(confirm("Remover este item/magia permanentemente?")) { 
                heroiAtivo[c].splice(i, 1); 
                await db.collection("personagens").doc(heroiAtivo.id).update(heroiAtivo); 
                // RenderTudo autom√°tico via listener
            } 
        }

        function ajustarCampos() {
            document.getElementById('campos-magia').style.display = document.getElementById('tipo-registro').value === 'magia' ? 'block' : 'none';
            document.getElementById('campos-item').style.display = document.getElementById('tipo-registro').value === 'item' ? 'block' : 'none';
        }

    </script>
</body>
</html>